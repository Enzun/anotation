# YOLOã‹ã‚‰nnU-Netã¸ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰

## ğŸ“š æ¦‚è¦
çœ¼çƒç­‹è‚‰ï¼ˆ6ã¤ï¼šso, io, sr, ir, lr, mrï¼‰ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’YOLOv8ã‹ã‚‰nnU-Net v2ã«ç§»è¡Œã—ã¾ã™ã€‚

## ğŸ”„ ç¾åœ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã®æ¯”è¼ƒ

| å·¥ç¨‹ | YOLOï¼ˆç¾åœ¨ï¼‰ | nnU-Netï¼ˆç§»è¡Œå¾Œï¼‰ |
|------|------------|-----------------|
| ãƒ‡ãƒ¼ã‚¿å½¢å¼ | LabelMe JSON + TIFF | NIfTI (.nii.gz) |
| å­¦ç¿’ | yoloTrain.py | train_nnunet.py |
| æ¨è«– | ultralytics YOLO | nnUNetv2_predict |
| GUIç¢ºèª | ãã®ã¾ã¾ä½¿ç”¨å¯èƒ½ | nnunet_inference.pyçµŒç”±ã§ä½¿ç”¨ |
| ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£ | CVAT â†’ JSON | å¤‰æ›´ãªã—ï¼ˆCVAT â†’ JSON â†’ NIfTIï¼‰ |

## ğŸ“¦ ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

1. **setup_nnunet.sh** - ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
2. **prepare_nnunet_data.py** - ãƒ‡ãƒ¼ã‚¿å¤‰æ›ï¼ˆJSONâ†’NIfTIï¼‰
3. **train_nnunet.py** - å­¦ç¿’å®Ÿè¡Œ
4. **nnunet_inference.py** - GUIç”¨æ¨è«–ãƒ©ãƒƒãƒ‘ãƒ¼
5. **run_nnunet_example.sh** - å®Ÿè¡Œä¾‹

## ğŸš€ å®Ÿè¡Œæ‰‹é †

### 1ï¸âƒ£ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# nnU-Net v2ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ç’°å¢ƒå¤‰æ•°è¨­å®š
bash setup_nnunet.sh
```

### 2ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿æº–å‚™
```bash
# JSONã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’nnU-Netå½¢å¼ã«å¤‰æ›
python prepare_nnunet_data.py \
  --json_dir datasets/2024_07_11_09_34_02/filtered_json4 \
  --image_dir DATA/Tiffs/eT1W_SE_tra/ \
  --train_ratio 0.8
```

### 3ï¸âƒ£ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
```bash
# ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã¨å‰å‡¦ç†
python train_nnunet.py --mode plan --task_id 501

# å­¦ç¿’é–‹å§‹ï¼ˆ100ã‚¨ãƒãƒƒã‚¯ï¼‰
python train_nnunet.py --mode train --task_id 501 --epochs 100
```

### 4ï¸âƒ£ æ¨è«–ãƒ†ã‚¹ãƒˆ
```bash
python train_nnunet.py --mode predict --task_id 501 \
  --input_folder /path/to/test/images \
  --output_folder /home/claude/predictions
```

## ğŸ¯ GUIãƒ„ãƒ¼ãƒ«ã§nnU-Netãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨

### æ–¹æ³•1: æ¨è«–ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰
```python
from nnunet_inference import NnUNetPredictor

# åˆæœŸåŒ–
predictor = NnUNetPredictor(task_id=501)

# äºˆæ¸¬å®Ÿè¡Œ
img, label_areas = predictor.predict_from_dicom(dicom_path)
```

### æ–¹æ³•2: GUIãƒ„ãƒ¼ãƒ«ã®ä¿®æ­£
gui.pyã§YOLOãƒ¢ãƒ‡ãƒ«ã®ä»£ã‚ã‚Šã«nnU-Net predictorã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†å¤‰æ›´

## âš¡ ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

### nnU-Netã®ãƒ¡ãƒªãƒƒãƒˆ
âœ… åŒ»ç™‚ç”»åƒã«ç‰¹åŒ–ã—ãŸæœ€é©åŒ–
âœ… è‡ªå‹•çš„ãªå‰å‡¦ç†ãƒ»å¾Œå‡¦ç†
âœ… ã‚¯ãƒ­ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
âœ… 3Dç”»åƒã¸ã®æ‹¡å¼µãŒå®¹æ˜“
âœ… ç ”ç©¶ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã§ã®å®Ÿç¸¾å¤šæ•°

### è€ƒæ…®äº‹é …
âš ï¸ å­¦ç¿’æ™‚é–“ãŒé•·ã„ï¼ˆYOLOã‚ˆã‚Šé…ã„ï¼‰
âš ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨è«–ã«ã¯ä¸å‘ã
âš ï¸ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒã‚„ã‚„è¤‡é›‘

## ğŸ“ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
[DICOM/TIFFç”»åƒ]
      â†“
[JSONã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³] 
      â†“
[prepare_nnunet_data.py] â†’ NIfTIå½¢å¼ã«å¤‰æ›
      â†“
[nnU-Netå­¦ç¿’] â†’ ãƒ¢ãƒ‡ãƒ«ç”Ÿæˆ
      â†“
[GUIç¢ºèª] â†’ é–“é•ã„ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—
      â†“
[CVATä¿®æ­£] â†’ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ”¹å–„
      â†“
[è¿½åŠ å­¦ç¿’] â†’ ãƒ¢ãƒ‡ãƒ«æ”¹å–„
```

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ãƒ©ãƒ™ãƒ«ã®å¤‰æ›´
`prepare_nnunet_data.py`ã®`LABEL_MAP`ã‚’ç·¨é›†ï¼š
```python
LABEL_MAP = {
    "so": 1,  # ä¸Šæ–œç­‹
    "io": 2,  # ä¸‹æ–œç­‹
    # ... è¿½åŠ /å¤‰æ›´
}
```

### å­¦ç¿’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- ã‚¨ãƒãƒƒã‚¯æ•°: `--epochs`
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆ: `--configuration` (2d/3d_fullres/3d_lowres)
- ãƒãƒƒãƒã‚µã‚¤ã‚º: nnU-NetãŒè‡ªå‹•èª¿æ•´

## ğŸ’¡ Tips

1. **GPUä½¿ç”¨**: CUDAç’°å¢ƒãŒã‚ã‚Œã°è‡ªå‹•çš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™
2. **ãƒ¡ãƒ¢ãƒªä¸è¶³**: ãƒãƒƒãƒã‚µã‚¤ã‚ºã¯nnU-NetãŒè‡ªå‹•èª¿æ•´
3. **å­¦ç¿’ã®ä¸­æ–­/å†é–‹**: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰è‡ªå‹•å†é–‹å¯èƒ½
4. **è¤‡æ•°fold**: ã‚¯ãƒ­ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«è¤‡æ•°foldå­¦ç¿’å¯èƒ½

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ç’°å¢ƒå¤‰æ•°ã‚¨ãƒ©ãƒ¼
```bash
export nnUNet_raw="/home/claude/nnunet_data/nnUNet_raw"
export nnUNet_preprocessed="/home/claude/nnunet_data/nnUNet_preprocessed"
export nnUNet_results="/home/claude/nnunet_data/nnUNet_results"
```

### ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- JSONã¨TIFF/DICOMã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- ãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹ç¢ºèª

### å­¦ç¿’ãŒé€²ã¾ãªã„
- ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã™ããªã„ã‹ç¢ºèªï¼ˆæœ€ä½20æšç¨‹åº¦æ¨å¥¨ï¼‰
- ãƒ­ã‚°ã‚’ç¢ºèª: `$nnUNet_results/Dataset501_EyeMuscleSegmentation/`

## ğŸ“§ è³ªå•ãƒ»ã‚µãƒãƒ¼ãƒˆ

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
